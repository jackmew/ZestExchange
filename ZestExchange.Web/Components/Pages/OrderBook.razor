@page "/orderbook"
@rendermode InteractiveServer
@implements IAsyncDisposable
@using Orleans
@using Orleans.Streams
@using ZestExchange.Contracts.Grains
@using ZestExchange.Contracts.OrderBook
@using ZestExchange.Contracts.Events
@inject IClusterClient ClusterClient

<PageTitle>OrderBook</PageTitle>

<h1>OrderBook - BTC-USDT</h1>
<p class="text-muted">Real-time updates via Orleans Streams</p>

<div class="row">
    <div class="col-6">
        <h4 style="color: green;">Bids (Buy Orders)</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Price</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody>
                @if (_bids.Count == 0)
                {
                    <tr><td colspan="2" class="text-muted">No bids</td></tr>
                }
                else
                {
                    @foreach (var bid in _bids)
                    {
                        <tr style="color: green;">
                            <td>@bid.Price.ToString("F2")</td>
                            <td>@bid.TotalQuantity.ToString("F4")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="col-6">
        <h4 style="color: red;">Asks (Sell Orders)</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Price</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody>
                @if (_asks.Count == 0)
                {
                    <tr><td colspan="2" class="text-muted">No asks</td></tr>
                }
                else
                {
                    @foreach (var ask in _asks)
                    {
                        <tr style="color: red;">
                            <td>@ask.Price.ToString("F2")</td>
                            <td>@ask.TotalQuantity.ToString("F4")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3">
    <small class="text-muted">
        Last Update: @_lastUpdate.ToString("HH:mm:ss.fff")
        | Updates: @_updateCount
        | Status: @_status
    </small>
</div>

@code {
    private List<PriceLevelDto> _bids = new();
    private List<PriceLevelDto> _asks = new();
    private DateTime _lastUpdate = DateTime.MinValue;
    private int _updateCount = 0;
    private string _status = "Connecting...";

    private StreamSubscriptionHandle<OrderBookUpdated>? _subscription;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Initial load from Grain
            var grain = ClusterClient.GetGrain<IMatchingEngineGrain>("BTC-USDT");
            var snapshot = await grain.GetOrderBookAsync(5);
            _bids = snapshot.Bids;
            _asks = snapshot.Asks;
            _lastUpdate = snapshot.Timestamp;
            _status = "Connected";

            // Subscribe to Orleans Stream for real-time updates
            var streamProvider = ClusterClient.GetStreamProvider("OrderBookProvider");
            var stream = streamProvider.GetStream<OrderBookUpdated>(
                StreamId.Create("orderbook", "BTC-USDT"));

            _subscription = await stream.SubscribeAsync(OnOrderBookUpdated);
            _status = "Subscribed to stream";
        }
        catch (Exception ex)
        {
            _status = $"Error: {ex.Message}";
        }
    }

    private Task OnOrderBookUpdated(OrderBookUpdated update, StreamSequenceToken? token)
    {
        _bids = update.Bids;
        _asks = update.Asks;
        _lastUpdate = update.Timestamp;
        _updateCount++;

        // Trigger UI re-render (Blazor Server uses SignalR to push to browser)
        InvokeAsync(StateHasChanged);

        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        if (_subscription != null)
        {
            await _subscription.UnsubscribeAsync();
        }
    }
}
