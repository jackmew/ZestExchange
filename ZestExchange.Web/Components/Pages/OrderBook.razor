@page "/orderbook"
@page "/orderbook/{Symbol}"
@rendermode InteractiveServer
@implements IAsyncDisposable
@using Orleans
@using Orleans.Streams
@using ZestExchange.Contracts.Grains
@using ZestExchange.Contracts.OrderBook
@using ZestExchange.Contracts.Events
@inject IClusterClient ClusterClient

<PageTitle>OrderBook - @Symbol</PageTitle>

<div class="d-flex justify-content-between align-items-center">
    <h1>OrderBook - @Symbol</h1>
    <div class="btn-group">
        <a href="/orderbook/BTC-USDT" class="btn btn-outline-primary @(Symbol == "BTC-USDT" ? "active" : "")">BTC-USDT</a>
        <a href="/orderbook/ETH-USDT" class="btn btn-outline-primary @(Symbol == "ETH-USDT" ? "active" : "")">ETH-USDT</a>
    </div>
</div>
<p class="text-muted">Real-time updates via Orleans Streams</p>

<div class="row">
    <div class="col-6">
        <h4 style="color: green;">Bids (Buy Orders)</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Price</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody>
                @if (_bids.Count == 0)
                {
                    <tr><td colspan="2" class="text-muted">No bids</td></tr>
                }
                else
                {
                    @foreach (var bid in _bids)
                    {
                        <tr style="color: green;">
                            <td>@bid.Price.ToString("F2")</td>
                            <td>@bid.TotalQuantity.ToString("F4")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="col-6">
        <h4 style="color: red;">Asks (Sell Orders)</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Price</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody>
                @if (_asks.Count == 0)
                {
                    <tr><td colspan="2" class="text-muted">No asks</td></tr>
                }
                else
                {
                    @foreach (var ask in _asks)
                    {
                        <tr style="color: red;">
                            <td>@ask.Price.ToString("F2")</td>
                            <td>@ask.TotalQuantity.ToString("F4")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3">
    <small class="text-muted">
        Last Update: @_lastUpdate.ToString("HH:mm:ss.fff")
        | Updates: @_updateCount
        | Status: @_status
    </small>
</div>

@code {
    [Parameter]
    public string? Symbol { get; set; }

    private string _currentSubscribedSymbol = "";
    private List<PriceLevelDto> _bids = new();
    private List<PriceLevelDto> _asks = new();
    private DateTime _lastUpdate = DateTime.MinValue;
    private int _updateCount = 0;
    private string _status = "Connecting...";

    private StreamSubscriptionHandle<OrderBookUpdated>? _subscription;

    protected override async Task OnParametersSetAsync()
    {
        // Default symbol
        if (string.IsNullOrEmpty(Symbol)) Symbol = "BTC-USDT";
        Symbol = Symbol.ToUpper();

        // Only re-subscribe if the symbol actually changed
        if (Symbol != _currentSubscribedSymbol)
        {
            await SubscribeToSymbol(Symbol);
        }
    }

    private async Task SubscribeToSymbol(string symbol)
    {
        try
        {
            _status = $"Switching to {symbol}...";
            
            // 1. Cleanup old subscription
            if (_subscription != null)
            {
                await _subscription.UnsubscribeAsync();
                _subscription = null;
                _updateCount = 0;
            }

            // 2. Initial load from Grain
            var grain = ClusterClient.GetGrain<IMatchingEngineGrain>(symbol);
            var snapshot = await grain.GetOrderBookAsync(5);
            _bids = snapshot.Bids;
            _asks = snapshot.Asks;
            _lastUpdate = snapshot.Timestamp;

            // 3. Subscribe to Orleans Stream
            var streamProvider = ClusterClient.GetStreamProvider("OrderBookProvider");
            var stream = streamProvider.GetStream<OrderBookUpdated>(
                StreamId.Create("orderbook", symbol));

            _subscription = await stream.SubscribeAsync(OnOrderBookUpdated);
            
            _currentSubscribedSymbol = symbol;
            _status = $"Subscribed to {symbol}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _status = $"Error: {ex.Message}";
        }
    }

    private Task OnOrderBookUpdated(OrderBookUpdated update, StreamSequenceToken? token)
    {
        _bids = update.Bids;
        _asks = update.Asks;
        _lastUpdate = update.Timestamp;
        _updateCount++;

        InvokeAsync(StateHasChanged);

        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        if (_subscription != null)
        {
            try { await _subscription.UnsubscribeAsync(); } catch { }
        }
    }
}
